{% extends '_layout.html' %}

{% block extra_head %}
  {% include 'templates/datatables.html' %}
{% endblock %}

{% block content %}
<div class="main-body">

  <!-- MAIN CONTAINER AREA -->
  <div id="main-container">

    <!-- INFORMATION -->
    <div class="info-field">
      <div class="info-description">
        Her kan du 
        <a class="link info-link" href="{{ url_for('app.booking') }}">låne bort</a> 
        og 
        <a class="link info-link" href="{{ url_for('app.innlevering') }}">levere inn</a> utstyr!
      </div>
    </div>

    <!-- CARDS -->
    <div id="card-container">
      <!-- A CARD BUTTON -->
      <a class="card tall-button" href="{{ url_for('app.booking') }}">
        <div class="card-inner">
          <div class="card-background">
            <img class="card-background-image" src="https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&q=80" alt="Lån ut utstyr bilde">
            <div class="card-gradient-cover"></div>
          </div>
          <div class="card-content-wrapper">
            <div class="card-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera text-white/90 w-10 h-10"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
            </div>
            <div class="card-content">
              <div class="card-info">
                <div class="card-title">
                  Låne ut utstyr
                </div>
                <div class="card-description">
                  Registrer nytt utlån av kamera, lys eller lydutstyr
                </div>
              </div>
              <div class="link card-link">
                Klikk her
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right transform transition-transform duration-300 group-hover:translate-x-1"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
              </div>
            </div>
          </div>
        </div>
      </a>      

      <a class="card tall-button" href="{{ url_for('app.innlevering') }}">
        <div class="card-inner">
          <div class="card-background">
            <img class="card-background-image" src="https://images.unsplash.com/photo-1578575437130-527eed3abbec?auto=format&fit=crop&q=80" alt="Lån ut utstyr bilde">
            <div class="card-gradient-cover"></div>
          </div>
          <div class="card-content-wrapper">
            <div class="card-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload text-white/90 w-10 h-10"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" x2="12" y1="3" y2="15"></line></svg>
            </div>
            <div class="card-content">
              <div class="card-info">
                <div class="card-title">
                  Lever inn utstyr
                </div>
                <div class="card-description">
                  Registrer innlevering av utstyr
                </div>
              </div>
              <div class="link card-link">
                Klikk her
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right transform transition-transform duration-300 group-hover:translate-x-1"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>
              </div>
            </div>
          </div>
        </div>
      </a>
      
    </div>

    <!-- ADMINISTER BUTTON -->
    <a class="wide-button" href="{{ url_for('app.inventar') }}">
      <div class="wide-button-inner">
        <div class="wide-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings2 text-blue-600 dark:text-blue-400 transition-transform duration-200 group-hover:rotate-45"><path d="M20 7h-9"></path><path d="M14 17H5"></path><circle cx="17" cy="17" r="3"></circle><circle cx="7" cy="7" r="3"></circle></svg>
        </div>
        <div class="wide-description">
          Administrer utstyr
        </div>
      </div>
    </a>    

    <h2 class="overdue-title" style="text-align: center;">Overskredet utstyr:</h2>
    {% if overdue_items %}
    <div id="overdue_items">
    
      <!-- Toolbar: length menu, info text, and search -->
      <div class="dt-toolbar">
        <!-- Rows per page (length menu) -->
        <div class="custom-length">
          <label>
            Viser 
            <select id="rows-per-page">
              <option value="10">10 per side</option>
              <option value="20">20 per side</option>
              <option value="30">30 per side</option>
              <option value="-1">Alle</option>
            </select>
          </label>
        </div>
    
        <!-- Info text: "Viser X resultater" -->
        <div class="custom-info" id="custom-info">
          <!-- Populated by JS, e.g. "Viser 12 resultater" -->
        </div>
    
        <!-- Search box -->
        <div class="custom-filter">
          <label class="search-box">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search h-5 w-5 text-gray-400"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            <input 
              type="text" 
              id="custom-search" 
              placeholder="Søk etter utstyr eller person..."
            >
          </label>
        </div>
      </div>
    
      <!-- Table -->
      <div id="overdue-table-wrapper">
        <table id="active" class="overdue-table">
          <thead>
            <tr>
              <th>Løpenummer</th>
              <th>Utstyr</th>
              <th>Utlånt til</th>
              <th>Leveringsfrist</th>
              <th>Alternativer</th>
            </tr>
          </thead>
          <tbody id="datatable-body" style="display: none;">
            {% for item in overdue_items %}
            <tr class="item-row item-row--overdue">
              <td>{{ item.id }}</td>
              <td>{{ item.name }} ({{ item.category }})</td>
              <td>
                {{ item.lender_name }}
                <small>
                  ({{ item.classroom }}{% if item.teacher %}, {{ item.teacher }}{% endif %})
                </small>
              </td>
              <td data-sort="{{ item.order_due_date }}" class="">
                {{ item.order_due_date|strftime }}
              </td>
              <td>
                <a class="delay-button" onclick="postpone('{{ item.id }}', '{{ item.lender }}', this.parentNode.parentNode)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar "><path d="M8 2v4"></path><path d="M16 2v4"></path><rect width="18" height="18" x="3" y="4" rx="2"></rect><path d="M3 10h18"></path></svg>
                  Utsett
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    
    <script>
      // Show the table body once the page loads
      document.getElementById('datatable-body').style.display = '';
    
      // 1) Grab references to DOM elements
      const searchInput  = document.getElementById('custom-search');
      const lengthSelect = document.getElementById('rows-per-page');
      const infoDisplay  = document.getElementById('custom-info');
      const tableBody    = document.getElementById('datatable-body');
    
      // 2) Convert table rows to an array for easy filtering
      let allRows = Array.from(tableBody.querySelectorAll('tr'));
    
      // 3) Function to filter rows based on the search input
      function filterRows() {
        const searchTerm = searchInput.value.toLowerCase();
        return allRows.filter(row => {
          // Check if any cell text matches the search term
          const cellsText = row.innerText.toLowerCase();
          return cellsText.includes(searchTerm);
        });
      }
    
      // 4) Function to render the filtered rows with the selected row limit
      function renderTable() {
        const filtered = filterRows();
        const limit = parseInt(lengthSelect.value, 10);
    
        // Clear table body
        tableBody.innerHTML = '';
    
        // If limit is -1, show all rows; otherwise show only 'limit' rows
        const rowsToShow = (limit === -1) ? filtered : filtered.slice(0, limit);
    
        rowsToShow.forEach(row => tableBody.appendChild(row));
    
        // Update info text
        infoDisplay.textContent = `Viser ${filtered.length} resultater`;
      }
    
      // 5) Attach event listeners for search and length changes
      searchInput.addEventListener('keyup',  renderTable);
      lengthSelect.addEventListener('change', renderTable);
    
      // 6) Initial render
      renderTable();
    
      // Existing postpone logic, unchanged
      function postpone(id, lender, tr) {
        $.confirm({
          title: `Utsett levering av '${id}'`,
          type: 'blue',
          icon: 'fa fa-calendar-plus-o',
          content: `<i>Lånt til ${lender}</i>` +
                   '<br><br>Utlånsfristen kan utsettes opp til 7 dager, kontaktlærer bør varsles om utsettelsen før den gjennomføres.',
          buttons: {
            oneDay: {
              text: '1 dag',
              btnClass: 'btn-blue',
              action: function () {
                submitPostpone(id, tr, 1);
              }
            },
            threeDays: {
              text: '3 dager',
              btnClass: 'btn-blue',
              action: function () {
                submitPostpone(id, tr, 3);
              }
            },
            sevenDays: {
              text: '1 uke',
              btnClass: 'btn-blue',
              action: function () {
                submitPostpone(id, tr, 7);
              }
            }
          }
        });
      }
    
      function submitPostpone(id, tr, days) {
        $.ajax({
          url: "{{ url_for('api.postpone_due_date') }}",
          data: {
            item_id: id,
            days: days
          },
          type: 'POST',
          success: function (response, status) {
            iziToast.success({
              title: 'Utsetter levering',
              message: response
            });
            tr.remove();
            // If no rows remain, remove the entire container
            if (!document.querySelector('.item-row')) {
              document.getElementById('overdue_items').remove();
            }
          },
          error: function (response, status) {
            iziToast.error({
              title: 'Feil',
              message: response.responseText,
            });
          }
        });
      }
    </script>
    {% endif %}
    

  </div>
</div>
{% endblock %}
